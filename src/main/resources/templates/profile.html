<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Thông tin cá nhân</title>

    <link rel="icon" th:href="@{/images/logo/logo.jpg}">

    <link rel="stylesheet" th:href="@{/css/bootstrap.min.css}">
    <script th:src="@{/js/bootstrap.js}"></script>
    <script th:src="@{/js/bootstrap.bundle.js}"></script>
    <script th:src="@{/js/fontawesome.js}" crossorigin="anonymous"></script>
    <script th:src="@{/js/jquery.js}"></script>
    <link rel="stylesheet" th:href="@{/css/frame_sale_product.css}">
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@24,400,1,0"/>
    <link rel="stylesheet" th:href="@{/css/index.css}">
    <link rel="stylesheet" th:href="@{/css/product.css}">
    <link rel="stylesheet" th:href="@{/css/menu.css}">
    <script th:src="@{/js/menu.js}"></script>

    <link rel="stylesheet" type="text/css" th:href="${'https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css'}">
    <script type="text/javascript" th:src="${'https://cdn.jsdelivr.net/npm/toastify-js'}"></script>
</head>
<body>
<header>
    <div th:replace="fragments/header_fragment::header"></div>
</header>
<main class="container pb-5 mt-4" th:with="user=${session.user}">
    <div class="d-flex bg-white rounded-3 p-3 gap-3">
        <section style="flex: 1; background-color: #f1f1f1" class="rounded-3">
            <div class="d-flex align-items-center flex-column m-3">
                <div class="rounded-circle overflow-hidden bg-warning position-relative"
                     style="width: 100px; height: 100px">
                    <label class="w-100 h-100">
                        <input type="file" hidden="" id="avatar">
                    </label>
                    <p class="position-absolute top-50 start-50 fw-bold fs-3 text-white"
                       style="transform: translate(-50%, -50%)">KIMI</p>
                </div>
                <p class="mt-2">
                    <span>Xin chào, </span>
                    <i class="text-primary fw-bold" th:text="${user.getLastName()} + ' ' + ${user.getFirstName()}"/>
                </p>
            </div>
            <nav class="bg-primary m-3 rounded-3 overflow-hidden">
                <button data-index-slide="1"
                        class="text-white text-start w-100 border-0 bg-warning p-3 active profile-menu">
                    <i class="fa-solid fa-user fs-4"></i>
                    Thông tin tài khoản
                </button>
                <button data-index-slide="2" class="text-white text-start w-100 border-0 bg-primary p-3 profile-menu">
                    <i class="fa-solid fa-box fs-4"></i>
                    Danh sách đơn hàng
                </button>
            </nav>
        </section>

        <section data-slide="1" style="flex: 3; background-color: #f1f1f1" class="rounded-3 p-3 slide">
            <h4 class="text-warning text-uppercase">Thông tin tài khoản</h4>
            <div class="d-flex mb-2">
                <label class="w-100">
                    <span>Họ: </span> <span class="text-danger fw-bold">*</span> <br>
                    <input class="border border-1 border-secondary rounded rounded-3 p-2 w-100 user-first-name"
                           name="firstName"
                           required
                           placeholder="Họ" th:value="${user.getFirstName()}"/>
                </label>
            </div>
            <div class="d-flex mb-2">
                <label class="w-100">
                    <span>Tên: </span> <span class="text-danger fw-bold">*</span> <br>
                    <input class="border border-1 border-secondary rounded rounded-3 p-2 w-100 user-last-name"
                           name="lastName"
                           required
                           placeholder="Tên" th:value="${user.getLastName()}"/>
                </label>
            </div>
            <div class="d-flex mb-2">
                <span>Email: </span> <span class="text-danger fw-bold" th:text="${user.email}"/> <br>
            </div>
            <div class="d-flex mb-2">
                <label class="w-100">
                    <span>Số điện thoại: </span> <span class="text-danger fw-bold">*</span> <br>
                    <input class="border border-1 border-secondary rounded rounded-3 p-2 w-100 user-phone"
                           name="phone"
                           required
                           placeholder="Số điện thoại"
                           th:value="${user.phone}"/>
                </label>
            </div>
            <div class="d-flex justify-content-center">
                <button class="p-2 bg-primary fw-bold text-white border-secondary rounded-3 border-0"
                        id="update-profile">
                    Cập nhật thông tin
                </button>
            </div>
        </section>
        <section data-slide="2" style="flex: 3; background-color: #f1f1f1" class="rounded-3 p-3 slide">
            <h4 class="text-warning text-uppercase">Danh sách đơn hàng</h4>
        </section>
    </div>
</main>
<footer>
    <div th:replace="fragments/footer_fragment::foother"></div>
</footer>
<div id="see-more"></div>
<script type="module" th:src="@{/js/product.js}"></script>
<script>
    $(document).ready(function () {
        const profileMenu = $('.profile-menu'),
            userFirstName = $('.user-first-name'),
            userLastName = $('.user-last-name'),
            userPhone = $('.user-phone');

        profileMenu.click(function () {
            profileMenu.removeClass('bg-warning').addClass('bg-primary');
            $('.profile-menu').removeClass('active');
            $(this).removeClass("bg-primary").addClass('active').addClass("bg-warning");
            const index = $(this).data("index-slide");
            $(".slide").hide();
            $(`.slide[data-slide="${index}"]`).show();
        });

        profileMenu.eq(0).click()

        profileMenu.on("mouseenter", function () {
            profileMenu.not("button.active.profile-menu").addClass('bg-primary');
            profileMenu.not("button.active.profile-menu").removeClass('bg-warning');
            $(this).addClass('bg-warning');
        });

        profileMenu.on("mouseleave", function () {
            $(this).not("button.active.profile-menu").removeClass('bg-warning');
        });

        $("#update-profile").click(function () {
            updateProfile(userFirstName.val(), userLastName.val(), userPhone.val())
        });
    });

    const updateProfile = (userFirstName, userLastName, userPhone) => {
        $.ajax({
            url: '/stationery_kimi/api/user/update-profile',
            type: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify({
                firstName: userFirstName,
                lastName: userLastName,
                phone: userPhone
            }),
            success: function (response) {
                Toastify({
                    text: "Cập nhật thông tin thành công",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: 'right',
                    backgroundColor: "linear-gradient(to right, #00b09b, #96c93d)",
                }).showToast();

                const data = response.data;
                updateDataProfile(userFirstName, userLastName, userPhone, data)
            },
            error: function (data) {
                Toastify({
                    text: "Cập nhật thông tin thất bại",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: 'right',
                    backgroundColor: "linear-gradient(to right, #ff5f6d, #ffc371)",
                }).showToast();
            }
        });
    }

    const updateDataProfile = (userFirstName, userLastName, userPhone, data) => {
        userFirstName.val(data.firstName);
        userLastName.val(data.lastName);
        userPhone.val(data.phone);
    }
</script>
</body>
</html>